/* Code generated by Beremiz c_ext confnode */

#ifdef ARDUINO_PLATFORM

#include <stdio.h>
#include "iec_types_all.h"

/* User variables reference */
extern "C" __IEC_BOOL_t CONFIG0__ZERO_M1_KAKI_OK;
#define zero_m1_kaki_ok CONFIG0__ZERO_M1_KAKI_OK.value
extern "C" __IEC_BOOL_t CONFIG0__ZERO_M2_KAKI_OK;
#define zero_m2_kaki_ok CONFIG0__ZERO_M2_KAKI_OK.value
extern "C" __IEC_BOOL_t CONFIG0__ZERO_M3_KAKI_OK;
#define zero_m3_kaki_ok CONFIG0__ZERO_M3_KAKI_OK.value
extern "C" __IEC_BOOL_t CONFIG0__ZERO_M4_KAKI_OK;
#define zero_m4_kaki_ok CONFIG0__ZERO_M4_KAKI_OK.value
extern "C" __IEC_BOOL_t CONFIG0__ZERO_M5_KAKI_OK;
#define zero_m5_kaki_ok CONFIG0__ZERO_M5_KAKI_OK.value
extern "C" __IEC_BOOL_t CONFIG0__ZERO_M6_KAKI_OK;
#define zero_m6_kaki_ok CONFIG0__ZERO_M6_KAKI_OK.value
extern "C" __IEC_BOOL_t CONFIG0__ZERO_M7_KAKI_OK;
#define zero_m7_kaki_ok CONFIG0__ZERO_M7_KAKI_OK.value
extern "C" __IEC_BOOL_t CONFIG0__ZERO_M8_KAKI_OK;
#define zero_m8_kaki_ok CONFIG0__ZERO_M8_KAKI_OK.value
extern "C" __IEC_DWORD_t CONFIG0__POSITION_MOTOR1_1;
#define position_motor1_1 CONFIG0__POSITION_MOTOR1_1.value
extern "C" __IEC_DWORD_t CONFIG0__POSITION_MOTOR2_1;
#define position_motor2_1 CONFIG0__POSITION_MOTOR2_1.value
extern "C" __IEC_DWORD_t CONFIG0__POSITION_MOTOR3_1;
#define position_motor3_1 CONFIG0__POSITION_MOTOR3_1.value
extern "C" __IEC_DWORD_t CONFIG0__POSITION_MOTOR4_1;
#define position_motor4_1 CONFIG0__POSITION_MOTOR4_1.value
extern "C" __IEC_DWORD_t CONFIG0__POSITION_MOTOR5_1;
#define position_motor5_1 CONFIG0__POSITION_MOTOR5_1.value
extern "C" __IEC_DWORD_t CONFIG0__POSITION_MOTOR6_1;
#define position_motor6_1 CONFIG0__POSITION_MOTOR6_1.value
extern "C" __IEC_DWORD_t CONFIG0__POSITION_MOTOR7_1;
#define position_motor7_1 CONFIG0__POSITION_MOTOR7_1.value
extern "C" __IEC_DWORD_t CONFIG0__POSITION_MOTOR8_1;
#define position_motor8_1 CONFIG0__POSITION_MOTOR8_1.value
extern "C" __IEC_BOOL_t CONFIG0__CW_M1;
#define cw_m1 CONFIG0__CW_M1.value
extern "C" __IEC_BOOL_t CONFIG0__CW_M2;
#define cw_m2 CONFIG0__CW_M2.value
extern "C" __IEC_BOOL_t CONFIG0__CW_M3;
#define cw_m3 CONFIG0__CW_M3.value
extern "C" __IEC_BOOL_t CONFIG0__CW_M4;
#define cw_m4 CONFIG0__CW_M4.value
extern "C" __IEC_BOOL_t CONFIG0__CW_M5;
#define cw_m5 CONFIG0__CW_M5.value
extern "C" __IEC_BOOL_t CONFIG0__CW_M6;
#define cw_m6 CONFIG0__CW_M6.value
extern "C" __IEC_BOOL_t CONFIG0__CW_M7;
#define cw_m7 CONFIG0__CW_M7.value
extern "C" __IEC_BOOL_t CONFIG0__CW_M8;
#define cw_m8 CONFIG0__CW_M8.value
extern "C" __IEC_BOOL_t CONFIG0__CCW_M1;
#define ccw_m1 CONFIG0__CCW_M1.value
extern "C" __IEC_BOOL_t CONFIG0__CCW_M2;
#define ccw_m2 CONFIG0__CCW_M2.value
extern "C" __IEC_BOOL_t CONFIG0__CCW_M3;
#define ccw_m3 CONFIG0__CCW_M3.value
extern "C" __IEC_BOOL_t CONFIG0__CCW_M4;
#define ccw_m4 CONFIG0__CCW_M4.value
extern "C" __IEC_BOOL_t CONFIG0__CCW_M5;
#define ccw_m5 CONFIG0__CCW_M5.value
extern "C" __IEC_BOOL_t CONFIG0__CCW_M6;
#define ccw_m6 CONFIG0__CCW_M6.value
extern "C" __IEC_BOOL_t CONFIG0__CCW_M7;
#define ccw_m7 CONFIG0__CCW_M7.value
extern "C" __IEC_BOOL_t CONFIG0__CCW_M8;
#define ccw_m8 CONFIG0__CCW_M8.value
extern "C" __IEC_BYTE_t CONFIG0__DATA_MOTO1;
#define data_moto1 CONFIG0__DATA_MOTO1.value
extern "C" __IEC_BYTE_t CONFIG0__DATA_MOTO2;
#define data_moto2 CONFIG0__DATA_MOTO2.value
extern "C" __IEC_BYTE_t CONFIG0__DATA_MOTO3;
#define data_moto3 CONFIG0__DATA_MOTO3.value
extern "C" __IEC_BYTE_t CONFIG0__DATA_MOTO4;
#define data_moto4 CONFIG0__DATA_MOTO4.value
extern "C" __IEC_BYTE_t CONFIG0__DATA_MOTO5;
#define data_moto5 CONFIG0__DATA_MOTO5.value
extern "C" __IEC_BYTE_t CONFIG0__DATA_MOTO6;
#define data_moto6 CONFIG0__DATA_MOTO6.value
extern "C" __IEC_BYTE_t CONFIG0__DATA_MOTO7;
#define data_moto7 CONFIG0__DATA_MOTO7.value
extern "C" __IEC_BYTE_t CONFIG0__DATA_MOTO8;
#define data_moto8 CONFIG0__DATA_MOTO8.value
extern "C" __IEC_DWORD_t CONFIG0__CURRENT_M1_POS;
#define current_M1_pos CONFIG0__CURRENT_M1_POS.value
extern "C" __IEC_DWORD_t CONFIG0__CURRENT_M2_POS;
#define current_M2_pos CONFIG0__CURRENT_M2_POS.value
extern "C" __IEC_DWORD_t CONFIG0__CURRENT_M3_POS;
#define current_M3_pos CONFIG0__CURRENT_M3_POS.value
extern "C" __IEC_DWORD_t CONFIG0__CURRENT_M4_POS;
#define current_M4_pos CONFIG0__CURRENT_M4_POS.value
extern "C" __IEC_DWORD_t CONFIG0__CURRENT_M5_POS;
#define current_M5_pos CONFIG0__CURRENT_M5_POS.value
extern "C" __IEC_DWORD_t CONFIG0__CURRENT_M6_POS;
#define current_M6_pos CONFIG0__CURRENT_M6_POS.value
extern "C" __IEC_DWORD_t CONFIG0__CURRENT_M7_POS;
#define current_M7_pos CONFIG0__CURRENT_M7_POS.value
extern "C" __IEC_DWORD_t CONFIG0__CURRENT_M8_POS;
#define current_M8_pos CONFIG0__CURRENT_M8_POS.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR1_SPEED;
#define motor1_speed CONFIG0__MOTOR1_SPEED.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR2_SPEED;
#define motor2_speed CONFIG0__MOTOR2_SPEED.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR3_SPEED;
#define motor3_speed CONFIG0__MOTOR3_SPEED.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR4_SPEED;
#define motor4_speed CONFIG0__MOTOR4_SPEED.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR5_SPEED;
#define motor5_speed CONFIG0__MOTOR5_SPEED.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR6_SPEED;
#define motor6_speed CONFIG0__MOTOR6_SPEED.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR7_SPEED;
#define motor7_speed CONFIG0__MOTOR7_SPEED.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR8_SPEED;
#define motor8_speed CONFIG0__MOTOR8_SPEED.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR1_ACCEL;
#define motor1_accel CONFIG0__MOTOR1_ACCEL.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR2_ACCEL;
#define motor2_accel CONFIG0__MOTOR2_ACCEL.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR3_ACCEL;
#define motor3_accel CONFIG0__MOTOR3_ACCEL.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR4_ACCEL;
#define motor4_accel CONFIG0__MOTOR4_ACCEL.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR5_ACCEL;
#define motor5_accel CONFIG0__MOTOR5_ACCEL.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR6_ACCEL;
#define motor6_accel CONFIG0__MOTOR6_ACCEL.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR7_ACCEL;
#define motor7_accel CONFIG0__MOTOR7_ACCEL.value
extern "C" __IEC_UINT_t CONFIG0__MOTOR8_ACCEL;
#define motor8_accel CONFIG0__MOTOR8_ACCEL.value
extern "C" __IEC_BOOL_t CONFIG0__START_MOTO_1;
#define START_Moto_1 CONFIG0__START_MOTO_1.value
extern "C" __IEC_BOOL_t CONFIG0__START_MOTO_2;
#define START_Moto_2 CONFIG0__START_MOTO_2.value
extern "C" __IEC_BOOL_t CONFIG0__START_MOTO_3;
#define START_Moto_3 CONFIG0__START_MOTO_3.value
extern "C" __IEC_BOOL_t CONFIG0__START_MOTO_4;
#define START_Moto_4 CONFIG0__START_MOTO_4.value
extern "C" __IEC_BOOL_t CONFIG0__START_MOTO_5;
#define START_Moto_5 CONFIG0__START_MOTO_5.value
extern "C" __IEC_BOOL_t CONFIG0__START_MOTO_6;
#define START_Moto_6 CONFIG0__START_MOTO_6.value
extern "C" __IEC_BOOL_t CONFIG0__START_MOTO_7;
#define START_Moto_7 CONFIG0__START_MOTO_7.value
extern "C" __IEC_BOOL_t CONFIG0__START_MOTO_8;
#define START_Moto_8 CONFIG0__START_MOTO_8.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR1_RUNNING;
#define motor1_running CONFIG0__MOTOR1_RUNNING.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR2_RUNNING;
#define motor2_running CONFIG0__MOTOR2_RUNNING.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR3_RUNNING;
#define motor3_running CONFIG0__MOTOR3_RUNNING.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR4_RUNNING;
#define motor4_running CONFIG0__MOTOR4_RUNNING.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR5_RUNNING;
#define motor5_running CONFIG0__MOTOR5_RUNNING.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR6_RUNNING;
#define motor6_running CONFIG0__MOTOR6_RUNNING.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR7_RUNNING;
#define motor7_running CONFIG0__MOTOR7_RUNNING.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR8_RUNNING;
#define motor8_running CONFIG0__MOTOR8_RUNNING.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR1_POSITION_OK;
#define motor1_position_ok CONFIG0__MOTOR1_POSITION_OK.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR2_POSITION_OK;
#define motor2_position_ok CONFIG0__MOTOR2_POSITION_OK.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR3_POSITION_OK;
#define motor3_position_ok CONFIG0__MOTOR3_POSITION_OK.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR4_POSITION_OK;
#define motor4_position_ok CONFIG0__MOTOR4_POSITION_OK.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR5_POSITION_OK;
#define motor5_position_ok CONFIG0__MOTOR5_POSITION_OK.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR6_POSITION_OK;
#define motor6_position_ok CONFIG0__MOTOR6_POSITION_OK.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR7_POSITION_OK;
#define motor7_position_ok CONFIG0__MOTOR7_POSITION_OK.value
extern "C" __IEC_BOOL_t CONFIG0__MOTOR8_POSITION_OK;
#define motor8_position_ok CONFIG0__MOTOR8_POSITION_OK.value
extern "C" __IEC_BOOL_t CONFIG0__LR_0;
#define lr_0 CONFIG0__LR_0.value
extern "C" __IEC_BOOL_t CONFIG0__LR_1;
#define lr_1 CONFIG0__LR_1.value
extern "C" __IEC_BOOL_t CONFIG0__LR_2;
#define lr_2 CONFIG0__LR_2.value
extern "C" __IEC_BOOL_t CONFIG0__LR_3;
#define lr_3 CONFIG0__LR_3.value
extern "C" __IEC_BOOL_t CONFIG0__LR_4;
#define lr_4 CONFIG0__LR_4.value
extern "C" __IEC_BOOL_t CONFIG0__LR_5;
#define lr_5 CONFIG0__LR_5.value
extern "C" __IEC_BOOL_t CONFIG0__LR_6;
#define lr_6 CONFIG0__LR_6.value
extern "C" __IEC_BOOL_t CONFIG0__LR_7;
#define lr_7 CONFIG0__LR_7.value
extern "C" __IEC_BOOL_t CONFIG0__LR_8;
#define lr_8 CONFIG0__LR_8.value
extern "C" __IEC_BOOL_t CONFIG0__LR_9;
#define lr_9 CONFIG0__LR_9.value
extern "C" __IEC_BOOL_t CONFIG0__LR_10;
#define lr_10 CONFIG0__LR_10.value
extern "C" __IEC_BOOL_t CONFIG0__LR_11;
#define lr_11 CONFIG0__LR_11.value
extern "C" __IEC_BOOL_t CONFIG0__LR_12;
#define lr_12 CONFIG0__LR_12.value
extern "C" __IEC_BOOL_t CONFIG0__LR_13;
#define lr_13 CONFIG0__LR_13.value
extern "C" __IEC_BOOL_t CONFIG0__LR_14;
#define lr_14 CONFIG0__LR_14.value
extern "C" __IEC_BOOL_t CONFIG0__LR_15;
#define lr_15 CONFIG0__LR_15.value
extern "C" __IEC_DWORD_t CONFIG0__DM_0;
#define dm_0 CONFIG0__DM_0.value
extern "C" __IEC_DWORD_t CONFIG0__DM_1;
#define dm_1 CONFIG0__DM_1.value
extern "C" __IEC_DWORD_t CONFIG0__DM_2;
#define dm_2 CONFIG0__DM_2.value
extern "C" __IEC_DWORD_t CONFIG0__DM_3;
#define dm_3 CONFIG0__DM_3.value
extern "C" __IEC_DWORD_t CONFIG0__DM_4;
#define dm_4 CONFIG0__DM_4.value
extern "C" __IEC_DWORD_t CONFIG0__DM_5;
#define dm_5 CONFIG0__DM_5.value
extern "C" __IEC_DWORD_t CONFIG0__DM_6;
#define dm_6 CONFIG0__DM_6.value
extern "C" __IEC_DWORD_t CONFIG0__DM_7;
#define dm_7 CONFIG0__DM_7.value
extern "C" __IEC_DWORD_t CONFIG0__DM_8;
#define dm_8 CONFIG0__DM_8.value
extern "C" __IEC_DWORD_t CONFIG0__DM_9;
#define dm_9 CONFIG0__DM_9.value
extern "C" __IEC_DWORD_t CONFIG0__DM_10;
#define dm_10 CONFIG0__DM_10.value
extern "C" __IEC_DWORD_t CONFIG0__DM_11;
#define dm_11 CONFIG0__DM_11.value
extern "C" __IEC_DWORD_t CONFIG0__DM_12;
#define dm_12 CONFIG0__DM_12.value
extern "C" __IEC_DWORD_t CONFIG0__DM_13;
#define dm_13 CONFIG0__DM_13.value
extern "C" __IEC_DWORD_t CONFIG0__DM_14;
#define dm_14 CONFIG0__DM_14.value
extern "C" __IEC_DWORD_t CONFIG0__DM_15;
#define dm_15 CONFIG0__DM_15.value
extern "C" __IEC_DWORD_t CONFIG0__DM_16;
#define dm_16 CONFIG0__DM_16.value
extern "C" __IEC_DWORD_t CONFIG0__DM_17;
#define dm_17 CONFIG0__DM_17.value
extern "C" __IEC_DWORD_t CONFIG0__DM_18;
#define dm_18 CONFIG0__DM_18.value
extern "C" __IEC_DWORD_t CONFIG0__DM_19;
#define dm_19 CONFIG0__DM_19.value
extern "C" __IEC_UINT_t CONFIG0__COIL_256;
#define coil_256 CONFIG0__COIL_256.value

/* User sketch */
#include <EEPROM.h>

int address_byte = 0;
int address_word = 20;   //Location we want the data 32bit to be put.
//write
static uint8_t mm_8bit[2];
static uint32_t mm_32bit[20];
//read
static uint8_t value_8bit[2];
static uint32_t value_32bit[20];
static uint32_t mm_32bit_old_0,mm_32bit_old_1,mm_32bit_old_2,mm_32bit_old_3,
        mm_32bit_old_4,mm_32bit_old_5,mm_32bit_old_6,mm_32bit_old_7,mm_32bit_old_8,
        mm_32bit_old_9,mm_32bit_old_10,mm_32bit_old_11,mm_32bit_old_12,mm_32bit_old_13,
        mm_32bit_old_14,mm_32bit_old_15,mm_32bit_old_16,mm_32bit_old_17,mm_32bit_old_18,mm_32bit_old_19,mm_32bit_old_20;


static uint8_t mm_8bit_old_0,mm_8bit_old_1;
static uint8_t one_pulse0,one_pulse1;
#define INBUF_SIZE 64

static uint8_t inBuf[INBUF_SIZE];
static uint8_t checksum;
static uint8_t indRX;
static uint8_t cmdMSP;
static uint8_t data_motor_1 =0x00;
static uint8_t data_motor_2 =0x00;
static uint8_t data_motor_3 =0x00;
static uint8_t data_motor_4 =0x00;
static uint8_t data_motor_5 =0x00;
static uint8_t data_motor_6 =0x00;
static uint8_t data_motor_7 =0x00;
static uint8_t data_motor_8 =0x00;
static uint8_t data16bit[10];
static uint8_t data32bit[10];
static uint8_t mode_motor_1,mode_motor_2,mode_motor_3,mode_motor_4,mode_motor_5,mode_motor_6,mode_motor_7,mode_motor_8;

//request MSP
#define MSP_COMMAND_1                   1
#define MSP_COMMAND_2                   2
#define MSP_COMMAND_3                   3
#define MSP_COMMAND_4                   4
#define MSP_COMMAND_5                   5
#define MSP_COMMAND_6                   6
#define MSP_COMMAND_7                   7
#define MSP_COMMAND_8                   8
#define MSP_POSITION_M_1                10
#define MSP_POSITION_M_2                11
#define MSP_POSITION_M_3                12
#define MSP_POSITION_M_4                13
#define MSP_POSITION_M_5                14
#define MSP_POSITION_M_6                15
#define MSP_POSITION_M_7                16
#define MSP_POSITION_M_8                17
#define MSP_COMMAND_1_FEEDBACK       50
#define MSP_COMMAND_2_FEEDBACK       51
#define MSP_COMMAND_3_FEEDBACK       52
#define MSP_COMMAND_4_FEEDBACK       53
#define MSP_COMMAND_5_FEEDBACK       54
#define MSP_COMMAND_6_FEEDBACK       55
#define MSP_COMMAND_7_FEEDBACK       56
#define MSP_COMMAND_8_FEEDBACK       57

void evaluateOtherData(uint8_t sr);
void evaluateCommand(uint8_t c);
void eeprom();


static uint8_t read8() {
  return inBuf[indRX++] & 0xff;
}
static uint16_t read16() {
  uint16_t t = read8();
  t += (uint16_t)read8() << 8;
  return t;
}
static uint32_t read32() {
  uint32_t t = read16();
  t += (uint32_t)read16() << 16;
  return t;
}

static void serialize8(uint8_t a) {
  Serial1.write(a);
  checksum ^= a;
}
static void serialize16(int16_t a) {
  serialize8((a)&0xFF);
  serialize8((a >> 8) & 0xFF);
}
static void serialize32(uint32_t a) {
  serialize8((a)&0xFF);
  serialize8((a >> 8) & 0xFF);
  serialize8((a >> 16) & 0xFF);
  serialize8((a >> 24) & 0xFF);
}

static void headSerialResponse(uint8_t err, uint8_t s) {
  serialize8('$');
  serialize8('M');
  serialize8(err ? '!' : '>');
  checksum = 0;  // start calculating a new checksum
  serialize8(s);
  serialize8(cmdMSP);
}

static void headSerialReply(uint8_t s) {
  headSerialResponse(0, s);
}
static void headSerialError() {
  headSerialResponse(1, 0);
}
static void tailSerialReply() {
  serialize8(checksum);
}

static void serializeNames(PGM_P s) {
  headSerialReply(strlen_P(s));
  for (PGM_P c = s; pgm_read_byte(c); c++)
    serialize8(pgm_read_byte(c));
  tailSerialReply();
}

static void __attribute__((noinline)) s_struct_w(uint8_t *cb, uint8_t siz) {
  while (siz--) *cb++ = read8();
}
static void s_struct_partial(uint8_t *cb, uint8_t siz) {
  while (siz--) serialize8(*cb++);
}

static void s_struct(uint8_t *cb, uint8_t siz) {
  headSerialReply(siz);
  s_struct_partial(cb, siz);
  tailSerialReply();
}

static void mspAck() {
  headSerialReply(0);
  tailSerialReply();
}

enum MSP_protocol_bytes {
  IDLE,
  HEADER_START,
  HEADER_M,
  HEADER_ARROW,
  HEADER_SIZE,
  HEADER_CMD
};

void serialEvent() {
  uint8_t c, port, state, bytesTXBuff;
  static uint8_t offset;
  static uint8_t dataSize;
  static uint8_t c_state;
  uint32_t timeMax;  // limit max time in this function in case of GPS
  timeMax = micros();
  while (Serial1.available() > 0) {
    c = Serial1.read();
    state = c_state;
    if (state == IDLE) {
      if (c == '$') state = HEADER_START;
      else { state = IDLE; }  //evaluateOtherData(c);} // evaluate all other incoming serial data
    } else if (state == HEADER_START) {
      state = (c == 'M') ? HEADER_M : IDLE;
    } else if (state == HEADER_M) {
      state = (c == '>') ? HEADER_ARROW : IDLE;
    } else if (state == HEADER_ARROW) {
      if (c > INBUF_SIZE) {  // now we are expecting the payload size
        state = IDLE;
        continue;
      }
      dataSize = c;
      checksum = c;
      offset = 0;
      indRX = 0;
      state = HEADER_SIZE;  // the command is to follow
    } else if (state == HEADER_SIZE) {
      cmdMSP = c;
      checksum ^= c;
      state = HEADER_CMD;
    } else if (state == HEADER_CMD) {
      if (offset < dataSize) {
        checksum ^= c;
        inBuf[offset++] = c;
      } else {
        if (checksum == c)          // compare calculated and transferred checksum
          evaluateCommand(cmdMSP);  // we got a valid packet, evaluate it
        state = IDLE;
      }
    }
    c_state = state;
  }     // while
}

void evaluateCommand(uint8_t c) {
  switch(c) {

    case MSP_COMMAND_1_FEEDBACK:
      mode_motor_1 = read8();
      current_M1_pos = read32();
      motor1_running =     (mode_motor_1&0x01);
      motor1_position_ok = (mode_motor_1&0x02)>>1;
      zero_m1_kaki_ok =    (mode_motor_1&0x04)>>2;
      break;
    case MSP_COMMAND_2_FEEDBACK:
      mode_motor_2 = read8();
      current_M2_pos = read32();
      motor2_running =     (mode_motor_2&0x01);
      motor2_position_ok = (mode_motor_2&0x02)>>1;
      zero_m2_kaki_ok =    (mode_motor_2&0x04)>>2;
      break;
    case MSP_COMMAND_3_FEEDBACK:
      mode_motor_3 = read8();
      current_M3_pos = read32();
      motor3_running =     (mode_motor_3&0x01);
      motor3_position_ok = (mode_motor_3&0x02)>>1;
      zero_m3_kaki_ok =    (mode_motor_3&0x04)>>2;
      break;
    case MSP_COMMAND_4_FEEDBACK:
      mode_motor_4 = read8();
      current_M4_pos = read32();
      motor4_running =     (mode_motor_4&0x01);
      motor4_position_ok = (mode_motor_4&0x02)>>1;
      zero_m4_kaki_ok =    (mode_motor_4&0x04)>>2;
      break;
    case MSP_COMMAND_5_FEEDBACK:
      mode_motor_5 = read8();
      current_M5_pos = read32();
      motor5_running =     (mode_motor_5&0x01);
      motor5_position_ok = (mode_motor_5&0x02)>>1;
      zero_m5_kaki_ok =    (mode_motor_5&0x04)>>2;
      break;
    case MSP_COMMAND_6_FEEDBACK:
      mode_motor_6 = read8();
      current_M6_pos = read32();
      motor6_running =     (mode_motor_6&0x01);
      motor6_position_ok = (mode_motor_6&0x02)>>1;
      zero_m6_kaki_ok =    (mode_motor_6&0x04)>>2;
      break;
    case MSP_COMMAND_7_FEEDBACK:
      mode_motor_7 = read8();
      current_M7_pos = read32();
      motor7_running =     (mode_motor_7&0x01);
      motor7_position_ok = (mode_motor_7&0x02)>>1;
      zero_m7_kaki_ok =    (mode_motor_7&0x04)>>2;
      break;
    case MSP_COMMAND_8_FEEDBACK:
      mode_motor_8 = read8();
      current_M8_pos = read32();
      motor8_running =     (mode_motor_8&0x01);
      motor8_position_ok = (mode_motor_8&0x02)>>1;
      zero_m8_kaki_ok =    (mode_motor_8&0x04)>>2;
      break;
  }
}


void sketch_setup()

{

Serial1.begin(230400);

}



void sketch_loop()

{

eeprom();
/////////////////////////////MOTOR 1//////////////////
data_motor_1 = (cw_m1&0x01+ccw_m1&0x02);
cmdMSP = MSP_COMMAND_1;
headSerialReply(5);
serialize8(data_moto1);
serialize16(motor1_speed);
serialize16(motor1_accel);
tailSerialReply();

if (START_Moto_1 ==true){
cmdMSP = MSP_POSITION_M_1;
headSerialReply(4);
serialize32(position_motor1_1);
tailSerialReply();}

/////////////////////////////MOTOR 2//////////////////
data_motor_2 = (cw_m2&0x01+ccw_m2&0x02);
cmdMSP = MSP_COMMAND_2;
headSerialReply(5);
serialize8(data_moto2);
serialize16(motor2_speed);
serialize16(motor2_accel);
tailSerialReply();



if (START_Moto_2 ==true){
cmdMSP = MSP_POSITION_M_2;
headSerialReply(4);
serialize32(position_motor2_1);
tailSerialReply();}
/////////////////////////////MOTOR 3//////////////////

data_motor_3 = (cw_m3&0x01+ccw_m3&0x02);
cmdMSP = MSP_COMMAND_3;
headSerialReply(5);
serialize8(data_moto3);
serialize16(motor3_speed);
serialize16(motor3_accel);
tailSerialReply();

if (START_Moto_3 ==true){
cmdMSP = MSP_POSITION_M_3;
headSerialReply(4);
serialize32(position_motor3_1);
tailSerialReply();}

/////////////////////////////MOTOR 4//////////////////
data_motor_4 = (cw_m4&0x01+ccw_m4&0x02);
cmdMSP = MSP_COMMAND_4;
headSerialReply(5);
serialize8(data_moto4);
serialize16(motor4_speed);
serialize16(motor4_accel);
tailSerialReply();


if (START_Moto_4 ==true){
cmdMSP = MSP_POSITION_M_4;
headSerialReply(4);
serialize32(position_motor4_1);
tailSerialReply();}
/////////////////////////////MOTOR 5//////////////////
data_motor_5 = (cw_m5&0x01+ccw_m5&0x02);
cmdMSP = MSP_COMMAND_5;
headSerialReply(5);
serialize8(data_moto5);
serialize16(motor5_speed);
serialize16(motor5_accel);
tailSerialReply();

if (START_Moto_5 ==true){
cmdMSP = MSP_POSITION_M_5;
headSerialReply(4);
serialize32(position_motor5_1);
tailSerialReply();}

/////////////////////////////MOTOR 6//////////////////
data_motor_6 = (cw_m6&0x01+ccw_m6&0x02);
cmdMSP = MSP_COMMAND_6;
headSerialReply(5);
serialize8(data_moto6);
serialize16(motor6_speed);
serialize16(motor6_accel);
tailSerialReply();
if (START_Moto_6 ==true){
cmdMSP = MSP_POSITION_M_6;
headSerialReply(4);
serialize32(position_motor6_1);
tailSerialReply();}

/////////////////////////////MOTOR 7//////////////////
data_motor_7 = (cw_m7&0x01+ccw_m7&0x02);
cmdMSP = MSP_COMMAND_7;
headSerialReply(5);
serialize8(data_moto7);
serialize16(motor7_speed);
serialize16(motor7_accel);
tailSerialReply();
if (START_Moto_7 ==true){
cmdMSP = MSP_POSITION_M_7;
headSerialReply(4);
serialize32(position_motor7_1);
tailSerialReply();}
/////////////////////////////MOTOR 8//////////////////
data_motor_8 = (cw_m8&0x01+ccw_m8&0x02);
cmdMSP = MSP_COMMAND_8;
headSerialReply(5);
serialize8(data_moto8);
serialize16(motor8_speed);
serialize16(motor8_accel);
tailSerialReply();
if (START_Moto_8 ==true){
cmdMSP = MSP_POSITION_M_8;
headSerialReply(4);
serialize32(position_motor8_1);
tailSerialReply();}
serialEvent();
}

void eeprom()

{



mm_8bit[0] = ((lr_0&0x01)|(lr_1<<1)|(lr_2<<2)|(lr_3<<3)|(lr_4<<4)|(lr_5<<5)|(lr_6<<6)|(lr_7<<7))&0xFF;
mm_8bit[1] = ((lr_8&0x01)|(lr_9<<1)|(lr_10<<2)|(lr_11<<3)|(lr_12<<4)|(lr_13<<5)|(lr_14<<6)|(lr_15<<7))&0xFF;
if (mm_8bit[0]!= mm_8bit_old_0 ||mm_8bit[1]!= mm_8bit_old_1){
//address_byte = 0;


//for(int i= 0;i<2;i++){
//    EEPROM.write(address_byte, mm_8bit[i]);
//    address_byte = address_byte+1;
//}

//coil_256 =     mm_8bit[0];



EEPROM.write(0,mm_8bit[0]);

EEPROM.write(1,mm_8bit[1]);


mm_8bit_old_0 = mm_8bit[0];
mm_8bit_old_1 = mm_8bit[1];
}


/////////////////////////////////////////////////////////////////
if (dm_0!= mm_32bit_old_0 ||dm_1!= mm_32bit_old_1 ||dm_2!= mm_32bit_old_2 ||dm_3!= mm_32bit_old_3||dm_4!= mm_32bit_old_4 )
{

mm_32bit[0]= dm_0;
mm_32bit[1]= dm_1;
mm_32bit[2]= dm_2;
mm_32bit[3]= dm_3;
mm_32bit[4]= dm_4;
address_word = 20;
for(int i= 0;i<5;i++){
EEPROM.put(address_word, mm_32bit[i]);
address_word= address_word+4; 
}
mm_32bit_old_0 = mm_32bit[0];
mm_32bit_old_1 = mm_32bit[1];
mm_32bit_old_2 = mm_32bit[2];
mm_32bit_old_3 = mm_32bit[3];
mm_32bit_old_4 = mm_32bit[4];

}
if (dm_5!= mm_32bit_old_5 ||dm_6!= mm_32bit_old_6 ||dm_7!= mm_32bit_old_7 ||dm_8!= mm_32bit_old_8||dm_9!= mm_32bit_old_9 )
{

mm_32bit[5]= dm_5;
mm_32bit[6]= dm_6;
mm_32bit[7]= dm_7;
mm_32bit[8]= dm_8;
mm_32bit[9]= dm_9;
address_word = 40;
for(int i= 5;i<10;i++){
EEPROM.put(address_word, mm_32bit[i]);
address_word= address_word+4; 
}

mm_32bit_old_5 = mm_32bit[5];
mm_32bit_old_6 = mm_32bit[6];
mm_32bit_old_7 = mm_32bit[7];
mm_32bit_old_8 = mm_32bit[8];
mm_32bit_old_9 = mm_32bit[9];

}
if (dm_10!= mm_32bit_old_10||dm_11!= mm_32bit_old_11 ||dm_12!= mm_32bit_old_12 ||dm_13!= mm_32bit_old_13||dm_14!= mm_32bit_old_14 )
{

mm_32bit[10]= dm_10;
mm_32bit[11]= dm_11;
mm_32bit[12]= dm_12;
mm_32bit[13]= dm_13;
mm_32bit[14]= dm_14;
address_word = 60;
for(int i= 10;i<15;i++){
EEPROM.put(address_word, mm_32bit[i]);
address_word= address_word+4; 
}

mm_32bit_old_10 = mm_32bit[10];
mm_32bit_old_11 = mm_32bit[11];
mm_32bit_old_12 = mm_32bit[12];
mm_32bit_old_13 = mm_32bit[13];
mm_32bit_old_14 = mm_32bit[14];

}
if (dm_15!= mm_32bit_old_15 ||dm_16!= mm_32bit_old_16 ||dm_17!= mm_32bit_old_17 ||dm_18!= mm_32bit_old_18||dm_19!= mm_32bit_old_19 )
{

mm_32bit[15]= dm_15;
mm_32bit[16]= dm_16;
mm_32bit[17]= dm_17;
mm_32bit[18]= dm_18;
mm_32bit[19]= dm_19;
address_word = 80;
for(int i= 15;i<20;i++){
EEPROM.put(address_word, mm_32bit[i]);
address_word= address_word+4; 
}

mm_32bit_old_15 = mm_32bit[15];
mm_32bit_old_16 = mm_32bit[16];
mm_32bit_old_17 = mm_32bit[17];
mm_32bit_old_18 = mm_32bit[18];
mm_32bit_old_19 = mm_32bit[19];

}

//////////////////////////////////////////////////////////////////

if (one_pulse0 == 0){
for(int i= 0;i<2;i++){
   value_8bit[i] = EEPROM.read(i);
}

mm_8bit[0] = value_8bit[0];

mm_8bit[1] = value_8bit[1];


lr_0 =   mm_8bit[0]&0x01;
lr_1 =  (mm_8bit[0]>>1)&0x01;
lr_2 =  (mm_8bit[0]>>2)&0x01;
lr_3 =  (mm_8bit[0]>>3)&0x01;
lr_4 =  (mm_8bit[0]>>4)&0x01;
lr_5 =  (mm_8bit[0]>>5)&0x01;
lr_6 =  (mm_8bit[0]>>6)&0x01;
lr_7 =  (mm_8bit[0]>>7)&0x01;
lr_8 =   mm_8bit[1]&0x01;
lr_9 =  (mm_8bit[1]>>1)&0x01;
lr_10 = (mm_8bit[1]>>2)&0x01;
lr_11 = (mm_8bit[1]>>3)&0x01;
lr_12 = (mm_8bit[1]>>4)&0x01;
lr_13 = (mm_8bit[1]>>5)&0x01;
lr_14 = (mm_8bit[1]>>6)&0x01;
lr_15 = (mm_8bit[1]>>7)&0x01;



coil_256 = mm_8bit[0];
one_pulse0 =1;
}


if (one_pulse1 == 0){
address_word = 20;
for(int i= 0;i<20;i++){
    EEPROM.get(address_word , value_32bit[i]);
    address_word= address_word+4; 
}
dm_0 = value_32bit[0];
dm_1 = value_32bit[1];
dm_2 = value_32bit[2];
dm_3 = value_32bit[3];
dm_4 = value_32bit[4];
dm_5 = value_32bit[5];
dm_6 = value_32bit[6];
dm_7 = value_32bit[7];
dm_8 = value_32bit[8];
dm_9 = value_32bit[9];
dm_10 = value_32bit[10];
dm_11 = value_32bit[11];
dm_12 = value_32bit[12];
dm_13 = value_32bit[13];
dm_14 = value_32bit[14];
dm_15 = value_32bit[15];
dm_16 = value_32bit[16];
dm_17 = value_32bit[17];
dm_18 = value_32bit[18];
dm_19 = value_32bit[19];

one_pulse1 =1;
}

//  for (int i = 0 ; i < EEPROM.length() ; i++) {
//    EEPROM.write(i, 0);
//  }

//if (addr == EEPROM.length()) {
//    addr = 0;
//  }

}
#endif
